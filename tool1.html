<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cover-Analyse | Zyrix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --primary-color: #FCA311;
            --background-color: #0a0a0a;
            --card-background: #1E1E1E;
            --text-color: #E0E0E0;
            --text-secondary: #a0a0a0;
            --success-color: #00ff88;
            --error-color: #ff4444;
            --warning-color: #ffaa00;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--background-color ) 0%, #1a1a1a 100%);
            color: var(--text-color);
            min-height: 100vh;
        }

        .header {
            background: var(--card-background);
            padding: 20px;
            border-bottom: 1px solid rgba(252, 163, 17, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .back-button {
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: var(--primary-color);
            color: #000;
            transform: translateX(-2px);
        }

        .token-display {
            background: rgba(252, 163, 17, 0.1);
            border: 1px solid rgba(252, 163, 17, 0.3);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .token-icon {
            width: 20px;
            height: 20px;
            background: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
            font-size: 12px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #ffaa00 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .page-subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 40px;
            font-size: 1.1rem;
        }

        .tools-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
        }

        .tool-card {
            background: var(--card-background);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(252, 163, 17, 0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .tool-card:hover {
            border-color: rgba(252, 163, 17, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .tool-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .token-cost {
            background: linear-gradient(135deg, var(--primary-color) 0%, #ffaa00 100%);
            color: #000;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 15px rgba(252, 163, 17, 0.3);
        }

        .upload-area {
            border: 2px dashed rgba(252, 163, 17, 0.3);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            margin: 20px 0;
            transition: all 0.3s;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background: rgba(252, 163, 17, 0.05);
        }

        .upload-area.has-file {
            border-color: var(--success-color);
            background: rgba(0, 255, 136, 0.05);
        }

        .upload-area.dragging {
            border-color: var(--primary-color);
            background: rgba(252, 163, 17, 0.1);
            transform: scale(1.02);
        }

        .file-input { display: none; }

        .preview-container {
            display: none;
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            background: rgba(0, 255, 136, 0.05);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .preview-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .file-info {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 8px;
        }

        .analyze-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, var(--primary-color) 0%, #ffaa00 100%);
            border: none;
            border-radius: 12px;
            color: #000;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .analyze-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(252, 163, 17, 0.4);
        }

        .analyze-button:disabled {
            background: #555;
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #000;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .results {
            display: none;
            margin-top: 30px;
            padding: 25px;
            background: rgba(0, 255, 136, 0.05);
            border: 1px solid rgba(0, 255, 136, 0.2);
            border-radius: 12px;
            animation: slideIn 0.5s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results h3 {
            color: var(--success-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results h4 {
            color: var(--primary-color);
            margin: 20px 0 10px 0;
        }

        .results ul {
            margin-left: 20px;
        }

        .results li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .error-message {
            display: none;
            padding: 15px;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid rgba(255, 68, 68, 0.3);
            border-radius: 8px;
            color: var(--error-color);
            margin-top: 15px;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(145deg, var(--card-background) 0%, #2a2a2a 100%);
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            text-align: center;
            border: 1px solid rgba(252, 163, 17, 0.3);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-50px) scale(0.9); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .modal-text {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .modal-button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-family: 'Poppins', sans-serif;
        }

        .modal-button.primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, #ffaa00 100%);
            color: #000;
        }

        .modal-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(252, 163, 17, 0.4);
        }

        .modal-button.secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid #3A3A3A;
        }

        .modal-button.secondary:hover {
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background: var(--success-color); }
        .status-processing { background: var(--warning-color); animation: pulse 2s infinite; }
        .status-error { background: var(--error-color); }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @media (max-width: 768px) {
            .tools-grid { grid-template-columns: 1fr; }
            .page-title { font-size: 2rem; }
            .tool-card { padding: 20px; }
            .header { 
                flex-direction: column; 
                gap: 15px; 
                padding: 15px;
            }
            .modal-content { margin: 20% auto; }
            .modal-buttons { flex-direction: column; }
        }

        @media (max-width: 480px) {
            .container { padding: 20px 15px; }
            .upload-area { padding: 20px; }
            .analyze-button { font-size: 1rem; }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <a href="https://myzyrix.com/dashboard" class="back-button">
            ← Zurück zu myZyrix
        </a>
        <div class="token-display">
            <div class="token-icon">T</div>
            <span id="token-count">-</span> Tokens
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="container">
        <h1 class="page-title">Cover-Analyse</h1>
        <p class="page-subtitle">Professionelle KI-Analyse für maximale Verkaufswirkung</p>
        
        <div class="tools-grid">
            <!-- TOOL 1: COVER ANALYSE -->
            <div class="tool-card">
                <div class="tool-title">
                    <span>📖 Cover-Analyse</span>
                    <span class="token-cost">120 Tokens</span>
                </div>
                
                <div class="upload-area" id="cover-upload" onclick="document.getElementById('cover-file' ).click()">
                    <div style="font-size: 3rem; margin-bottom: 15px;">📚</div>
                    <div style="font-weight: 600; margin-bottom: 5px;">Cover hier hochladen</div>
                    <div style="color: var(--text-secondary); font-size: 0.9rem;">JPG, PNG oder WEBP (max. 10MB)</div>
                    <div style="color: var(--text-secondary); font-size: 0.8rem; margin-top: 8px;">Oder Datei hierher ziehen</div>
                </div>
                <input type="file" id="cover-file" class="file-input" accept="image/*">
                
                <div class="preview-container" id="cover-preview">
                    <img id="cover-image" class="preview-image" alt="Cover Preview">
                    <div class="file-info" id="cover-info"></div>
                </div>
                
                <button class="analyze-button" id="analyze-btn" disabled onclick="analyzeCover()">
                    <div class="button-content">
                        <span id="analyze-text">Cover analysieren</span>
                    </div>
                </button>
                
                <div class="error-message" id="cover-error"></div>
                <div class="results" id="cover-results">
                    <h3>
                        <span class="status-indicator status-online"></span>
                        Analyse-Ergebnisse
                    </h3>
                    <div id="cover-results-content"></div>
                </div>
            </div>

            <!-- TOOL 2: KONKURRENZ VERGLEICH -->
            <div class="tool-card">
                <div class="tool-title">
                    <span>🎯 Konkurrenz-Vergleich</span>
                    <span class="token-cost">150 Tokens</span>
                </div>
                
                <div style="margin-bottom: 15px; font-weight: 600; color: var(--primary-color);">1. Dein Cover:</div>
                <div class="upload-area" id="own-upload" onclick="document.getElementById('own-file').click()">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">📖</div>
                    <div>Dein Cover hochladen</div>
                </div>
                <input type="file" id="own-file" class="file-input" accept="image/*">
                <div class="preview-container" id="own-preview">
                    <img id="own-image" class="preview-image" alt="Own Cover">
                    <div class="file-info" id="own-info"></div>
                </div>
                
                <div style="margin: 20px 0 15px 0; font-weight: 600; color: var(--primary-color);">2. Konkurrenz-Cover:</div>
                <div class="upload-area" id="comp-upload" onclick="document.getElementById('comp-file').click()">
                    <div style="font-size: 2.5rem; margin-bottom: 10px;">🏆</div>
                    <div>Konkurrenz-Cover hochladen</div>
                </div>
                <input type="file" id="comp-file" class="file-input" accept="image/*">
                <div class="preview-container" id="comp-preview">
                    <img id="comp-image" class="preview-image" alt="Competitor Cover">
                    <div class="file-info" id="comp-info"></div>
                </div>
                
                <button class="analyze-button" id="compare-btn" disabled onclick="compareCovers()">
                    <div class="button-content">
                        <span id="compare-text">Cover vergleichen</span>
                    </div>
                </button>
                
                <div class="error-message" id="compare-error"></div>
                <div class="results" id="compare-results">
                    <h3>
                        <span class="status-indicator status-online"></span>
                        Vergleichs-Ergebnisse
                    </h3>
                    <div id="compare-results-content"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- INSUFFICIENT TOKENS MODAL -->
    <div id="tokens-modal" class="modal">
        <div class="modal-content">
            <h3 class="modal-title">
                ⚠️ Nicht genügend Tokens
            </h3>
            <p class="modal-text">
                Du benötigst mehr Tokens für diese Analyse. 
                Kaufe jetzt Tokens oder warte bis deine kostenlosen Tokens wieder aufgefüllt werden.
            </p>
            <div style="background: rgba(252, 163, 17, 0.1); padding: 15px; border-radius: 8px; margin: 20px 0;">
                <div style="font-weight: 600; margin-bottom: 5px;">Benötigt:</div>
                <div id="required-tokens" style="color: var(--primary-color); font-weight: 700;"></div>
            </div>
            <div class="modal-buttons">
                <button class="modal-button primary" onclick="window.open('https://myzyrix.com/tokens', '_blank' )">
                    Tokens kaufen
                </button>
                <button class="modal-button secondary" onclick="closeTokensModal()">
                    Schließen
                </button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const supabaseUrl = 'https://fhnegilgikynexhneoiq.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobmVnaWxnaWt5bmV4aG5lb2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NzM2MzQsImV4cCI6MjA2ODA0OTYzNH0.u_SBe_AtgUNHa-ogG8y9qFv8pr_u7-jvWBayhiwXOPE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey );

        // Global variables
        let currentUser = null;
        let userTokens = 0;
        let coverImageData = null;
        let ownImageData = null;
        let compImageData = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', initializeApp);

        async function initializeApp() {
            try {
                showStatus('Lade Anwendung...', 'processing');
                await checkAuth();
                await loadUserTokens();
                setupFileUploads();
                setupDragAndDrop();
                updateButtonStates();
                showStatus('Bereit', 'online');
            } catch (error) {
                console.error('Init error:', error);
                showError('Fehler beim Laden der Anwendung. Bitte lade die Seite neu.', 'cover-error');
                showStatus('Fehler', 'error');
            }
        }

        async function checkAuth() {
            const { data: { user }, error } = await supabase.auth.getUser();
            if (error || !user) {
                window.location.href = 'https://myzyrix.com/login';
                return;
            }
            currentUser = user;
        }

        async function loadUserTokens( ) {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase.rpc('get_total_active_tokens', {
                    user_id: currentUser.id
                });
                
                if (error) throw error;
                
                userTokens = data || 0;
                document.getElementById('token-count').textContent = userTokens.toLocaleString();
            } catch (error) {
                console.error('Token load error:', error);
                userTokens = 0;
                document.getElementById('token-count').textContent = '0';
            }
        }

        function setupFileUploads() {
            // Cover file
            document.getElementById('cover-file').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0], 'cover');
            });

            // Own cover file
            document.getElementById('own-file').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0], 'own');
            });

            // Competitor cover file
            document.getElementById('comp-file').addEventListener('change', function(e) {
                handleFileUpload(e.target.files[0], 'comp');
            });
        }

        function setupDragAndDrop() {
            const uploadAreas = ['cover-upload', 'own-upload', 'comp-upload'];
            
            uploadAreas.forEach(areaId => {
                const area = document.getElementById(areaId);
                const type = areaId.split('-')[0];
                
                area.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    area.classList.add('dragging');
                });
                
                area.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragging');
                });
                
                area.addEventListener('drop', (e) => {
                    e.preventDefault();
                    area.classList.remove('dragging');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        handleFileUpload(files[0], type);
                    }
                });
            });
        }

        function handleFileUpload(file, type) {
            if (!file) return;

            // Validate file
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                showError('Bitte wähle eine gültige Bilddatei (JPG, PNG, WEBP)', type + '-error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) {
                showError('Die Datei ist zu groß. Maximal 10MB erlaubt.', type + '-error');
                return;
            }

            // Show loading
            const uploadArea = document.getElementById(type + '-upload');
            uploadArea.style.opacity = '0.7';

            // Read file
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Data = e.target.result;
                
                if (type === 'cover') {
                    coverImageData = base64Data;
                    showPreview(base64Data, file, 'cover');
                    document.getElementById('cover-upload').classList.add('has-file');
                } else if (type === 'own') {
                    ownImageData = base64Data;
                    showPreview(base64Data, file, 'own');
                    document.getElementById('own-upload').classList.add('has-file');
                } else if (type === 'comp') {
                    compImageData = base64Data;
                    showPreview(base64Data, file, 'comp');
                    document.getElementById('comp-upload').classList.add('has-file');
                }
                
                updateButtonStates();
                hideError(type + '-error');
                uploadArea.style.opacity = '1';
            };
            
            reader.onerror = function() {
                showError('Fehler beim Lesen der Datei', type + '-error');
                uploadArea.style.opacity = '1';
            };
            
            reader.readAsDataURL(file);
        }

        function showPreview(base64Data, file, type) {
            const preview = document.getElementById(type + '-preview');
            const image = document.getElementById(type + '-image');
            const info = document.getElementById(type + '-info');
            
            image.src = base64Data;
            if (info) {
                const sizeKB = Math.round(file.size / 1024);
                info.textContent = `${file.name} (${sizeKB} KB)`;
            }
            preview.style.display = 'block';
        }

        function updateButtonStates() {
            const analyzeBtn = document.getElementById('analyze-btn');
            const compareBtn = document.getElementById('compare-btn');
            
            analyzeBtn.disabled = !coverImageData || userTokens < 120;
            compareBtn.disabled = !(ownImageData && compImageData) || userTokens < 150;
        }

        async function analyzeCover() {
            if (!coverImageData) {
                showError('Bitte lade zuerst ein Cover hoch.', 'cover-error');
                return;
            }

            if (userTokens < 120) {
                showTokensModal(120);
                return;
            }

            const btn = document.getElementById('analyze-btn');
            const text = document.getElementById('analyze-text');
            
            btn.disabled = true;
            text.innerHTML = '<div class="spinner"></div>Analysiere Cover...';
            showStatus('Analysiere...', 'processing');
            
            try {
                // Call secure backend function
                const { data, error } = await supabase.functions.invoke('analyze-cover', {
                    body: {
                        action: 'Cover-Analyse',
                        imageData: coverImageData,
                        tokenCost: 120,
                        prompt: `Analysiere dieses Buchcover professionell und detailliert auf Deutsch. Bewerte:
                        
                        1. Design-Qualität (Komposition, Farbschema, Typografie) - Bewertung 1-10
                        2. Genre-Passgenauigkeit (Signaling für Zielgruppe) - Bewertung 1-10  
                        3. Lesbarkeit (Titel, Autor, Thumbnail-Größe) - Bewertung 1-10
                        4. Emotionale Wirkung (erster Eindruck, Gefühle) - Bewertung 1-10
                        5. Verkaufspotential (Marktfähigkeit, Konkurrenzfähigkeit) - Bewertung 1-10
                        
                        Gib konkrete, umsetzbare Empfehlungen zur Verbesserung.
                        Strukturiere die Antwort mit HTML-Tags (h4, p, ul, li, strong).
                        Antworte professionell aber verständlich auf Deutsch.`
                    }
                });
                
                if (error) throw error;
                
                if (data.success) {
                    document.getElementById('cover-results-content').innerHTML = data.analysis;
                    document.getElementById('cover-results').style.display = 'block';
                    
                    // Update token count
                    userTokens -= data.tokensUsed;
                    document.getElementById('token-count').textContent = userTokens.toLocaleString();
                    
                    showStatus('Analyse abgeschlossen', 'online');
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Analyse fehlgeschlagen: ' + (error.message || 'Unbekannter Fehler'), 'cover-error');
                showStatus('Fehler', 'error');
            } finally {
                btn.disabled = false;
                text.textContent = 'Cover analysieren';
                updateButtonStates();
            }
        }

        async function compareCovers() {
            if (!ownImageData || !compImageData) {
                showError('Bitte lade beide Cover hoch.', 'compare-error');
                return;
            }

            if (userTokens < 150) {
                showTokensModal(150);
                return;
            }

            const btn = document.getElementById('compare-btn');
            const text = document.getElementById('compare-text');
            
            btn.disabled = true;
            text.innerHTML = '<div class="spinner"></div>Vergleiche Cover...';
            showStatus('Vergleiche...', 'processing');
            
            try {
                // Call secure backend function
                const { data, error } = await supabase.functions.invoke('analyze-cover', {
                    body: {
                        action: 'Cover-Vergleich',
                        imageData: ownImageData,
                        compImageData: compImageData,
                        tokenCost: 150,
                        prompt: `Vergleiche diese beiden Buchcover professionell und strategisch auf Deutsch:
                        
                        Erstes Bild: Das eigene Cover
                        Zweites Bild: Das Konkurrenz-Cover
                        
                        Analysiere:
                        1. Design-Qualität beider Cover (Bewertung 1-10 für jedes)
                        2. Genre-Signaling und Zielgruppen-Ansprache
                        3. Marktpositionierung und Wettbewerbsfähigkeit  
                        4. Stärken und Schwächen im direkten Vergleich
                        5. Strategische Empfehlungen für Verbesserungen
                        
                        Gib konkrete, umsetzbare Ratschläge zur Optimierung des eigenen Covers.
                        Strukturiere die Antwort mit HTML-Tags (h4, p, ul, li, strong).
                        Antworte professionell aber verständlich auf Deutsch.`
                    }
                });
                
                if (error) throw error;
                
                if (data.success) {
                    document.getElementById('compare-results-content').innerHTML = data.analysis;
                    document.getElementById('compare-results').style.display = 'block';
                    
                    // Update token count
                    userTokens -= data.tokensUsed;
                    document.getElementById('token-count').textContent = userTokens.toLocaleString();
                    
                    showStatus('Vergleich abgeschlossen', 'online');
                } else {
                    throw new Error(data.error || 'Unbekannter Fehler');
                }
                
            } catch (error) {
                console.error('Comparison error:', error);
                showError('Vergleich fehlgeschlagen: ' + (error.message || 'Unbekannter Fehler'), 'compare-error');
                showStatus('Fehler', 'error');
            } finally {
                btn.disabled = false;
                text.textContent = 'Cover vergleichen';
                updateButtonStates();
            }
        }

        function showTokensModal(requiredTokens) {
            document.getElementById('required-tokens').textContent = `${requiredTokens} Tokens (Du hast: ${userTokens})`;
            document.getElementById('tokens-modal').style.display = 'block';
        }

        function closeTokensModal() {
            document.getElementById('tokens-modal').style.display = 'none';
        }

        function showError(message, elementId) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }

        function hideError(elementId) {
            const errorDiv = document.getElementById(elementId);
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }

        function showStatus(message, type) {
            // Update status indicators
            const indicators = document.querySelectorAll('.status-indicator');
            indicators.forEach(indicator => {
                indicator.className = `status-indicator status-${type}`;
            });
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('tokens-modal');
            if (event.target === modal) {
                closeTokensModal();
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeTokensModal();
            }
        });
    </script>
</body>
</html>
