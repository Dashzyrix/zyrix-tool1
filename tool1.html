<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bild Cover Analyse - Zyrix</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0f0f0f;
            --secondary-bg: #1a1a1a;
            --accent-color: #ff9900;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --border-color: #333333;
            --success-color: #00ff88;
            --warning-color: #ffaa00;
            --error-color: #ff4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--primary-bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .zyrix-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
            min-height: 100vh;
        }

        .zyrix-hero {
            text-align: center;
            margin-bottom: 60px;
        }

        .zyrix-hero h1 {
            font-size: 3.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-color), #ffcc00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 20px;
        }

        .zyrix-hero p {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .zyrix-mode-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 60px;
        }

        .zyrix-mode-card {
            background: rgba(26, 26, 26, 0.8);
            border: 3px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .zyrix-mode-card:hover {
            border-color: var(--accent-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 153, 0, 0.2);
        }

        .zyrix-mode-card.active {
            border-color: var(--success-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .zyrix-mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-color), #ffcc00);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .zyrix-mode-card:hover::before,
        .zyrix-mode-card.active::before {
            opacity: 1;
        }

        .zyrix-mode-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            display: block;
        }

        .zyrix-mode-title {
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .zyrix-mode-description {
            color: var(--text-secondary);
            margin-bottom: 25px;
            line-height: 1.6;
        }

        .zyrix-mode-price {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-color), #ffcc00);
            color: #000;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .zyrix-form-container {
            display: none;
            background: rgba(26, 26, 26, 0.9);
            border: 2px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
        }

        .zyrix-form-container.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .zyrix-form-title {
            font-size: 2rem;
            font-weight: 600;
            color: var(--accent-color);
            margin-bottom: 30px;
            text-align: center;
        }

        .zyrix-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .zyrix-upload-section {
            background: rgba(15, 15, 15, 0.8);
            border: 2px dashed var(--border-color);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .zyrix-upload-section:hover {
            border-color: var(--accent-color);
            background: rgba(255, 153, 0, 0.05);
        }

        .zyrix-upload-section.dragover {
            border-color: var(--success-color);
            background: rgba(0, 255, 136, 0.1);
        }

        .zyrix-upload-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .zyrix-upload-icon {
            font-size: 3rem;
            color: var(--accent-color);
            margin-bottom: 15px;
            display: block;
        }

        .zyrix-upload-text {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        .zyrix-file-input {
            display: none;
        }

        .zyrix-upload-btn {
            background: linear-gradient(135deg, var(--accent-color), #ffcc00);
            color: #000;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .zyrix-upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 153, 0, 0.3);
        }

        .zyrix-file-preview {
            margin-top: 15px;
            display: none;
        }

        .zyrix-file-preview.active {
            display: block;
        }

        .zyrix-file-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
        }

        .zyrix-file-name {
            color: var(--success-color);
            font-weight: 500;
            margin-top: 10px;
        }

        .zyrix-form-fields {
            display: grid;
            gap: 25px;
        }

        .zyrix-field-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .zyrix-field-label {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.1rem;
        }

        .zyrix-field-input,
        .zyrix-field-select,
        .zyrix-field-textarea {
            background: rgba(15, 15, 15, 0.8);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .zyrix-field-input:focus,
        .zyrix-field-select:focus,
        .zyrix-field-textarea:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(255, 153, 0, 0.1);
        }

        .zyrix-field-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .zyrix-submit-section {
            text-align: center;
            margin-top: 40px;
        }

        .zyrix-submit-btn {
            background: linear-gradient(135deg, var(--success-color), #00cc70);
            color: #000;
            border: none;
            padding: 15px 40px;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: 600;
            transition: all 0.3s ease;
            min-width: 200px;
        }

        .zyrix-submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.3);
        }

        .zyrix-submit-btn:disabled {
            background: var(--border-color);
            color: var(--text-secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .zyrix-loading {
            display: none;
            text-align: center;
            margin-top: 30px;
        }

        .zyrix-loading.active {
            display: block;
        }

        .zyrix-spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .zyrix-loading-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .zyrix-result {
            display: none;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid var(--success-color);
            border-radius: 15px;
            padding: 30px;
            margin-top: 40px;
        }

        .zyrix-result.active {
            display: block;
            animation: slideIn 0.5s ease;
        }

        .zyrix-result h1,
        .zyrix-result h2,
        .zyrix-result h3 {
            color: var(--accent-color) !important;
            margin-bottom: 15px;
        }

        .zyrix-result p,
        .zyrix-result li {
            color: var(--text-primary) !important;
            line-height: 1.6;
            margin-bottom: 10px;
        }

        .zyrix-result table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .zyrix-result th,
        .zyrix-result td {
            border: 1px solid var(--border-color);
            padding: 12px;
            text-align: left;
            color: var(--text-primary) !important;
        }

        .zyrix-result th {
            background: rgba(255, 153, 0, 0.2);
            color: var(--accent-color) !important;
            font-weight: 600;
        }

        .zyrix-download-section {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
        }

        .zyrix-download-btn {
            background: linear-gradient(135deg, var(--warning-color), #ffcc00);
            color: #000;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .zyrix-download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3);
        }

        .zyrix-error {
            background: rgba(255, 68, 68, 0.1);
            border: 2px solid var(--error-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .zyrix-error.active {
            display: block;
        }

        .zyrix-error-text {
            color: var(--error-color);
            font-weight: 600;
        }

        .zyrix-token-warning {
            background: rgba(255, 170, 0, 0.1);
            border: 2px solid var(--warning-color);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
        }

        .zyrix-token-warning.active {
            display: block;
        }

        .zyrix-token-warning-text {
            color: var(--warning-color);
            font-weight: 600;
            margin-bottom: 15px;
        }

        .zyrix-buy-tokens-btn {
            background: linear-gradient(135deg, var(--warning-color), #ffcc00);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .zyrix-buy-tokens-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 170, 0, 0.3);
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .zyrix-hero h1 {
                font-size: 2.5rem;
            }

            .zyrix-mode-selector {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .zyrix-mode-card {
                padding: 30px 20px;
            }

            .zyrix-form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .zyrix-form-container {
                padding: 30px 20px;
            }
        }

        @media (max-width: 480px) {
            .zyrix-container {
                padding: 20px 15px;
            }

            .zyrix-hero h1 {
                font-size: 2rem;
            }

            .zyrix-mode-card {
                padding: 25px 15px;
            }

            .zyrix-mode-icon {
                font-size: 3rem;
            }

            .zyrix-mode-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="zyrix-container">
        <!-- Hero Section -->
        <div class="zyrix-hero">
            <h1>üì∏ Bild Cover Analyse</h1>
            <p>Professionelle Analyse Ihrer Buchcover und Produktbilder mit detailliertem Konkurrenzvergleich</p>
        </div>

        <!-- Mode Selector -->
        <div class="zyrix-mode-selector">
            <div class="zyrix-mode-card" onclick="selectMode('cover-analyse')">
                <span class="zyrix-mode-icon">üé®</span>
                <h3 class="zyrix-mode-title">Cover Analyse</h3>
                <p class="zyrix-mode-description">Detaillierte Analyse Ihres Covers mit Verbesserungsvorschl√§gen, Zielgruppen-Bewertung und Marktpositionierung</p>
                <span class="zyrix-mode-price">Einzelanalyse 120 Tokens</span>
            </div>

            <div class="zyrix-mode-card" onclick="selectMode('cover-vergleich')">
                <span class="zyrix-mode-icon">‚öîÔ∏è</span>
                <h3 class="zyrix-mode-title">Cover Vergleich</h3>
                <p class="zyrix-mode-description">Vergleichen Sie Ihr Cover mit 3 Konkurrenz-Covern und erhalten Sie eine detaillierte Wettbewerbsanalyse</p>
                <span class="zyrix-mode-price">Vergleichsanalyse 150 Tokens</span>
            </div>
        </div>

        <!-- Token Warning -->
        <div class="zyrix-token-warning" id="tokenWarning">
            <div class="zyrix-token-warning-text">‚ö†Ô∏è Nicht gen√ºgend Tokens verf√ºgbar!</div>
            <a href="https://www.zyrix.de" class="zyrix-buy-tokens-btn">üí≥ Tokens kaufen</a>
        </div>

        <!-- Cover Analyse Form -->
        <div class="zyrix-form-container" id="coverAnalyseForm">
            <h2 class="zyrix-form-title">üé® Cover Analyse</h2>
            
            <div class="zyrix-form-grid">
                <!-- Upload Section -->
                <div class="zyrix-upload-section" onclick="document.getElementById('coverFile').click()">
                    <span class="zyrix-upload-icon">üìÅ</span>
                    <h3 class="zyrix-upload-title">Cover hochladen</h3>
                    <p class="zyrix-upload-text">Klicken Sie hier oder ziehen Sie Ihr Cover hierher</p>
                    <button type="button" class="zyrix-upload-btn">Datei ausw√§hlen</button>
                    <input type="file" id="coverFile" class="zyrix-file-input" accept="image/*" onchange="handleFileUpload(this, 'coverPreview')">
                    <div class="zyrix-file-preview" id="coverPreview"></div>
                </div>

                <!-- Form Fields -->
                <div class="zyrix-form-fields">
                    <div class="zyrix-field-group">
                        <label class="zyrix-field-label">Produkttyp</label>
                        <select class="zyrix-field-select" id="productType">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="buch">Buch</option>
                            <option value="hoerbuch">H√∂rbuch</option>
                            <option value="ebook">E-Book</option>
                            <option value="kurs">Online-Kurs</option>
                            <option value="software">Software</option>
                            <option value="spiel">Spiel</option>
                            <option value="sonstiges">Sonstiges</option>
                        </select>
                    </div>

                    <div class="zyrix-field-group">
                        <label class="zyrix-field-label">Genre/Kategorie</label>
                        <input type="text" class="zyrix-field-input" id="genre" placeholder="z.B. Thriller, Romance, Business...">
                    </div>

                    <div class="zyrix-field-group">
                        <label class="zyrix-field-label">Preisbereich</label>
                        <select class="zyrix-field-select" id="priceRange">
                            <option value="">Bitte w√§hlen...</option>
                            <option value="0-10">0-10 ‚Ç¨</option>
                            <option value="10-25">10-25 ‚Ç¨</option>
                            <option value="25-50">25-50 ‚Ç¨</option>
                            <option value="50-100">50-100 ‚Ç¨</option>
                            <option value="100+">100+ ‚Ç¨</option>
                        </select>
                    </div>

                    <div class="zyrix-field-group">
                        <label class="zyrix-field-label">Zielgruppe</label>
                        <textarea class="zyrix-field-textarea" id="targetAudience" placeholder="Beschreiben Sie Ihre Zielgruppe detailliert (Alter, Interessen, Bed√ºrfnisse...)"></textarea>
                    </div>
                </div>
            </div>

            <div class="zyrix-submit-section">
                <button type="button" class="zyrix-submit-btn" onclick="startAnalysis('cover-analyse')">üöÄ Analyse starten (120 Tokens)</button>
            </div>
        </div>

        <!-- Cover Vergleich Form -->
        <div class="zyrix-form-container" id="coverVergleichForm">
            <h2 class="zyrix-form-title">‚öîÔ∏è Cover Vergleich</h2>
            
            <div class="zyrix-form-grid">
                <!-- Upload Sections -->
                <div class="zyrix-upload-section" onclick="document.getElementById('mainCoverFile').click()">
                    <span class="zyrix-upload-icon">üéØ</span>
                    <h3 class="zyrix-upload-title">Ihr Cover</h3>
                    <p class="zyrix-upload-text">Hauptcover f√ºr die Analyse</p>
                    <button type="button" class="zyrix-upload-btn">Datei ausw√§hlen</button>
                    <input type="file" id="mainCoverFile" class="zyrix-file-input" accept="image/*" onchange="handleFileUpload(this, 'mainCoverPreview')">
                    <div class="zyrix-file-preview" id="mainCoverPreview"></div>
                </div>

                <div class="zyrix-upload-section" onclick="document.getElementById('competitor1File').click()">
                    <span class="zyrix-upload-icon">ü•á</span>
                    <h3 class="zyrix-upload-title">Konkurrenz Cover 1</h3>
                    <p class="zyrix-upload-text">Erstes Vergleichscover</p>
                    <button type="button" class="zyrix-upload-btn">Datei ausw√§hlen</button>
                    <input type="file" id="competitor1File" class="zyrix-file-input" accept="image/*" onchange="handleFileUpload(this, 'competitor1Preview')">
                    <div class="zyrix-file-preview" id="competitor1Preview"></div>
                </div>

                <div class="zyrix-upload-section" onclick="document.getElementById('competitor2File').click()">
                    <span class="zyrix-upload-icon">ü•à</span>
                    <h3 class="zyrix-upload-title">Konkurrenz Cover 2</h3>
                    <p class="zyrix-upload-text">Zweites Vergleichscover</p>
                    <button type="button" class="zyrix-upload-btn">Datei ausw√§hlen</button>
                    <input type="file" id="competitor2File" class="zyrix-file-input" accept="image/*" onchange="handleFileUpload(this, 'competitor2Preview')">
                    <div class="zyrix-file-preview" id="competitor2Preview"></div>
                </div>

                <div class="zyrix-upload-section" onclick="document.getElementById('competitor3File').click()">
                    <span class="zyrix-upload-icon">ü•â</span>
                    <h3 class="zyrix-upload-title">Konkurrenz Cover 3</h3>
                    <p class="zyrix-upload-text">Drittes Vergleichscover</p>
                    <button type="button" class="zyrix-upload-btn">Datei ausw√§hlen</button>
                    <input type="file" id="competitor3File" class="zyrix-file-input" accept="image/*" onchange="handleFileUpload(this, 'competitor3Preview')">
                    <div class="zyrix-file-preview" id="competitor3Preview"></div>
                </div>
            </div>

            <div class="zyrix-form-fields">
                <div class="zyrix-field-group">
                    <label class="zyrix-field-label">Produkttyp</label>
                    <select class="zyrix-field-select" id="productTypeVergleich">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="buch">Buch</option>
                        <option value="hoerbuch">H√∂rbuch</option>
                        <option value="ebook">E-Book</option>
                        <option value="kurs">Online-Kurs</option>
                        <option value="software">Software</option>
                        <option value="spiel">Spiel</option>
                        <option value="sonstiges">Sonstiges</option>
                    </select>
                </div>

                <div class="zyrix-field-group">
                    <label class="zyrix-field-label">Genre/Kategorie</label>
                    <input type="text" class="zyrix-field-input" id="genreVergleich" placeholder="z.B. Thriller, Romance, Business...">
                </div>

                <div class="zyrix-field-group">
                    <label class="zyrix-field-label">Preisbereich</label>
                    <select class="zyrix-field-select" id="priceRangeVergleich">
                        <option value="">Bitte w√§hlen...</option>
                        <option value="0-10">0-10 ‚Ç¨</option>
                        <option value="10-25">10-25 ‚Ç¨</option>
                        <option value="25-50">25-50 ‚Ç¨</option>
                        <option value="50-100">50-100 ‚Ç¨</option>
                        <option value="100+">100+ ‚Ç¨</option>
                    </select>
                </div>

                <div class="zyrix-field-group">
                    <label class="zyrix-field-label">Zielgruppe</label>
                    <textarea class="zyrix-field-textarea" id="targetAudienceVergleich" placeholder="Beschreiben Sie Ihre Zielgruppe detailliert (Alter, Interessen, Bed√ºrfnisse...)"></textarea>
                </div>
            </div>

            <div class="zyrix-submit-section">
                <button type="button" class="zyrix-submit-btn" onclick="startAnalysis('cover-vergleich')">‚öîÔ∏è Vergleich starten (150 Tokens)</button>
            </div>
        </div>

        <!-- Loading -->
        <div class="zyrix-loading" id="loading">
            <div class="zyrix-spinner"></div>
            <div class="zyrix-loading-text">Analyse wird durchgef√ºhrt...</div>
        </div>

        <!-- Error -->
        <div class="zyrix-error" id="error">
            <div class="zyrix-error-text" id="errorText">Ein Fehler ist aufgetreten.</div>
        </div>

        <!-- Result -->
        <div class="zyrix-result" id="result">
            <div id="resultContent"></div>
            <div class="zyrix-download-section">
                <a href="#" class="zyrix-download-btn" id="downloadBtn" style="display: none;">
                    üìÑ PDF herunterladen
                </a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://fhnegilgikynexhneoiq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZobmVnaWxnaWt5bmV4aG5lb2lxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI0NzM2MzQsImV4cCI6MjA2ODA0OTYzNH0.u_SBe_AtgUNHa-ogG8y9qFv8pr_u7-jvWBayhiwXOPE';
        
        let supabase;
        let currentUser = null;
        let userTokens = 0;
        let selectedMode = null;

        // Initialize when page loads
        window.addEventListener('load', function() {
            initializeApp();
        });

        // Initialize application
        async function initializeApp() {
            try {
                // Initialize Supabase
                if (window.supabase) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    
                    // Try to get session, but don't block if it fails
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session) {
                            currentUser = session.user;
                            await loadUserTokens();
                        }
                    } catch (error) {
                        console.log('Auth check failed, but continuing anyway:', error);
                    }
                } else {
                    console.log('Supabase not loaded, but continuing anyway');
                }
                
                // Always show the interface
                console.log('App initialized successfully');
                
            } catch (error) {
                console.error('Initialization error:', error);
                // Continue anyway - don't block the interface
            }
        }

        // Load user tokens
        async function loadUserTokens() {
            if (!currentUser) {
                console.log('No current user, but assuming logged in from header');
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('user_token_balance')
                    .select('tokens')
                    .eq('user_id', currentUser.id)
                    .single();
                
                userTokens = data?.tokens || 0;
                console.log('User tokens loaded:', userTokens);
                
            } catch (error) {
                console.error('Token load error:', error);
                userTokens = 0;
            }
        }

        // Select mode
        function selectMode(mode) {
            selectedMode = mode;
            
            // Reset all cards
            const cards = document.querySelectorAll('.zyrix-mode-card');
            cards.forEach(card => card.classList.remove('active'));
            
            // Reset all forms
            const forms = document.querySelectorAll('.zyrix-form-container');
            forms.forEach(form => form.classList.remove('active'));
            
            // Hide warnings and results
            hideMessages();
            
            // Activate selected card
            event.target.closest('.zyrix-mode-card').classList.add('active');
            
            // Show form
            if (mode === 'cover-analyse') {
                document.getElementById('coverAnalyseForm').classList.add('active');
            } else if (mode === 'cover-vergleich') {
                document.getElementById('coverVergleichForm').classList.add('active');
            }
        }

        // Handle file upload
        function handleFileUpload(input, previewId) {
            const file = input.files[0];
            const preview = document.getElementById(previewId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `
                        <img src="${e.target.result}" alt="Preview">
                        <div class="zyrix-file-name">${file.name}</div>
                    `;
                    preview.classList.add('active');
                };
                reader.readAsDataURL(file);
            }
        }

        // Start analysis
        async function startAnalysis(mode) {
            try {
                hideMessages();
                showLoading();
                
                // Validate form
                if (!validateForm(mode)) {
                    hideLoading();
                    showError('Bitte f√ºllen Sie alle erforderlichen Felder aus.');
                    return;
                }
                
                // Try to get current session for user ID
                let userId = null;
                try {
                    if (supabase) {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session) {
                            userId = session.user.id;
                        }
                    }
                } catch (error) {
                    console.log('Could not get user session:', error);
                }
                
                if (!userId) {
                    hideLoading();
                    showError('Bitte melden Sie sich an, um die Analyse zu nutzen.');
                    return;
                }
                
                // Prepare form data
                const formData = new FormData();
                formData.append('mode', mode);
                formData.append('user_id', userId);
                
                if (mode === 'cover-analyse') {
                    formData.append('cover', document.getElementById('coverFile').files[0]);
                    formData.append('product_type', document.getElementById('productType').value);
                    formData.append('genre', document.getElementById('genre').value);
                    formData.append('price_range', document.getElementById('priceRange').value);
                    formData.append('target_audience', document.getElementById('targetAudience').value);
                } else {
                    formData.append('main_cover', document.getElementById('mainCoverFile').files[0]);
                    formData.append('competitor1', document.getElementById('competitor1File').files[0]);
                    formData.append('competitor2', document.getElementById('competitor2File').files[0]);
                    formData.append('competitor3', document.getElementById('competitor3File').files[0]);
                    formData.append('product_type', document.getElementById('productTypeVergleich').value);
                    formData.append('genre', document.getElementById('genreVergleich').value);
                    formData.append('price_range', document.getElementById('priceRangeVergleich').value);
                    formData.append('target_audience', document.getElementById('targetAudienceVergleich').value);
                }
                
                // Call edge function
                const { data, error } = await supabase.functions.invoke('cover-analysis', {
                    body: formData
                });
                
                hideLoading();
                
                if (error) {
                    throw error;
                }
                
                if (data.success) {
                    showResult(data.analysis, data.pdf_url);
                    // Reload tokens after successful analysis
                    await loadUserTokens();
                } else {
                    showError(data.error || 'Analyse fehlgeschlagen');
                }
                
            } catch (error) {
                hideLoading();
                console.error('Analysis error:', error);
                showError('Ein Fehler ist bei der Analyse aufgetreten: ' + error.message);
            }
        }

        // Validate form
        function validateForm(mode) {
            if (mode === 'cover-analyse') {
                const cover = document.getElementById('coverFile').files[0];
                const productType = document.getElementById('productType').value;
                const genre = document.getElementById('genre').value;
                const targetAudience = document.getElementById('targetAudience').value;
                
                return cover && productType && genre && targetAudience;
            } else {
                const mainCover = document.getElementById('mainCoverFile').files[0];
                const competitor1 = document.getElementById('competitor1File').files[0];
                const competitor2 = document.getElementById('competitor2File').files[0];
                const competitor3 = document.getElementById('competitor3File').files[0];
                const productType = document.getElementById('productTypeVergleich').value;
                const genre = document.getElementById('genreVergleich').value;
                const targetAudience = document.getElementById('targetAudienceVergleich').value;
                
                return mainCover && competitor1 && competitor2 && competitor3 && productType && genre && targetAudience;
            }
        }

        // Show/hide messages
        function showLoading() {
            document.getElementById('loading').classList.add('active');
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('error').classList.add('active');
        }

        function showTokenWarning() {
            document.getElementById('tokenWarning').classList.add('active');
        }

        function showResult(analysis, pdfUrl) {
            document.getElementById('resultContent').innerHTML = analysis;
            document.getElementById('result').classList.add('active');
            
            if (pdfUrl) {
                const downloadBtn = document.getElementById('downloadBtn');
                downloadBtn.href = pdfUrl;
                downloadBtn.style.display = 'inline-flex';
            }
        }

        function hideMessages() {
            document.getElementById('error').classList.remove('active');
            document.getElementById('tokenWarning').classList.remove('active');
            document.getElementById('result').classList.remove('active');
            document.getElementById('loading').classList.remove('active');
        }

        // Drag and drop functionality
        document.addEventListener('DOMContentLoaded', function() {
            const uploadSections = document.querySelectorAll('.zyrix-upload-section');
            
            uploadSections.forEach(section => {
                section.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    section.classList.add('dragover');
                });
                
                section.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    section.classList.remove('dragover');
                });
                
                section.addEventListener('drop', function(e) {
                    e.preventDefault();
                    section.classList.remove('dragover');
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        const input = section.querySelector('.zyrix-file-input');
                        const preview = section.querySelector('.zyrix-file-preview');
                        
                        input.files = files;
                        handleFileUpload(input, preview.id);
                    }
                });
            });
        });
    </script>
</body>
</html>

